name: ðŸ›¡ï¸ CodeQL å®‰å…¨æŽƒæèˆ‡è‡ªå‹•ä¿®æ­£å»ºè­°

on:
  push:
    branches:
      - '**'
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  security-events: write
  pull-requests: write

jobs:
  # â”€â”€ Job 1: CodeQL åˆ†æž â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  codeql-analyze:
    name: CodeQL å®‰å…¨åˆ†æž
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language:
          - csharp
          - javascript

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: âš™ï¸ è¨­å®š .NET ç’°å¢ƒ
        if: matrix.language == 'csharp'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: âš™ï¸ è¨­å®š Node.js ç’°å¢ƒ
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ”§ åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-extended,security-and-quality
          config: |
            paths:
              - src
              - frontend/src
            paths-ignore:
              - '**/*.test.*'
              - '**/*.spec.*'
              - '**/node_modules'
              - '**/bin'
              - '**/obj'

      - name: ðŸ—ï¸ è‡ªå‹•å»ºç½® .NET å°ˆæ¡ˆ
        if: matrix.language == 'csharp'
        run: dotnet build VMTO.sln

      - name: ðŸ—ï¸ å®‰è£å‰ç«¯ä¾è³´
        if: matrix.language == 'javascript'
        run: cd frontend && npm ci

      - name: ðŸ” åŸ·è¡Œ CodeQL åˆ†æž
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          upload: always

  # â”€â”€ Job 2: ç”Ÿæˆå ±å‘Šä¸¦ Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-report:
    name: ç”¢ç”Ÿå®‰å…¨å ±å‘Šä¸¦ Commit
    runs-on: ubuntu-latest
    needs: codeql-analyze
    if: always()
    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”Ž å–å¾— CodeQL å®‰å…¨è­¦å ±
        id: get-alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â–¶ï¸ æŸ¥è©¢ GitHub Code Scanning è­¦å ±..."

          ALERTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/code-scanning/alerts?state=open&per_page=50" \
            2>/dev/null || echo "[]")

          ALERT_COUNT=$(echo "$ALERTS" | jq 'length' 2>/dev/null || echo "0")
          echo "alert_count=$ALERT_COUNT" >> $GITHUB_OUTPUT
          echo "$ALERTS" > /tmp/security-alerts.json
          echo "âœ… å–å¾— ${ALERT_COUNT} å€‹å®‰å…¨è­¦å ±"

      - name: ðŸ¤– AI å®‰å…¨å•é¡Œåˆ†æžèˆ‡ä¿®æ­£å»ºè­°
        id: ai-security
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ALERT_COUNT="${{ steps.get-alerts.outputs.alert_count }}"
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

          if [ "$ALERT_COUNT" = "0" ]; then
            cat > /tmp/security-analysis.md << 'REPORT'
          ## ðŸ›¡ï¸ å®‰å…¨æŽƒæçµæžœ

          ### âœ… æœ¬æ¬¡æŽƒææœªç™¼ç¾å®‰å…¨æ¼æ´ž

          > CodeQL åˆ†æžå®Œæˆï¼Œæœªåµæ¸¬åˆ°å·²çŸ¥å®‰å…¨å•é¡Œã€‚

          ### ðŸ“‹ æŽƒæè¨­å®š
          - **æŽƒæèªžè¨€**: C#ã€JavaScript/TypeScript
          - **æŽƒæè¦å‰‡é›†**: security-extended + security-and-quality
          - **æŽƒæç¯„åœ**: `src/`ã€`frontend/src/`
          REPORT
          elif [ -n "$OPENAI_API_KEY" ]; then
            ALERTS_SUMMARY=$(cat /tmp/security-alerts.json | jq -r '
              .[:10] | map(
                "è­¦å ± #\(.number): \(.rule.description // .rule.id) [\(.rule.severity // "unknown")] - \(.most_recent_instance.location.path // "unknown"):\(.most_recent_instance.location.start_line // 0)"
              ) | join("\n")' 2>/dev/null || echo "ç„¡æ³•è§£æžè­¦å ±è³‡æ–™")

            PROMPT="ä½ æ˜¯ä¸€ä½è³‡æ·±è³‡å®‰å·¥ç¨‹å¸«ï¼Œå°ˆæ³¨æ–¼ C#/.NET 8 å’Œ TypeScript/Vue3 çš„å®‰å…¨æœ€ä½³å¯¦è¸ã€‚

          ä»¥ä¸‹æ˜¯ CodeQL åœ¨ VMTOï¼ˆVM Transfer Orchestratorï¼‰å°ˆæ¡ˆä¸­ç™¼ç¾çš„å®‰å…¨å•é¡Œï¼š

          $ALERTS_SUMMARY

          å°ˆæ¡ˆèƒŒæ™¯ï¼šClean Architecture DDD å°ˆæ¡ˆï¼ŒåŒ…å« ASP.NET Core Minimal APIã€MassTransit æ¶ˆè²»è€…ã€EF Coreã€Redisã€MinIOã€vSphere/PVE æ•´åˆã€‚

          è«‹ä»¥**ç¹é«”ä¸­æ–‡**æä¾›ï¼š

          ## ðŸ›¡ï¸ å®‰å…¨æ¼æ´žåˆ†æžèˆ‡ä¿®æ­£å»ºè­°

          ### ðŸ”´ é«˜å±éšªæ¼æ´ž
          ï¼ˆCRITICAL/HIGH ç­‰ç´šï¼Œéœ€ç«‹å³ä¿®æ­£ï¼‰

          ### ðŸŸ¡ ä¸­ç­‰é¢¨éšªæ¼æ´ž
          ï¼ˆMEDIUM ç­‰ç´šï¼‰

          ### ðŸŸ¢ ä½Žé¢¨éšªèˆ‡å»ºè­°
          ï¼ˆLOW/NOTE ç­‰ç´šï¼‰

          ### ðŸ”§ ä¿®æ­£å„ªå…ˆé †åº
          ï¼ˆæ¢åˆ—å¼è¡Œå‹•è¨ˆåŠƒï¼‰

          ### ðŸ’¡ å®‰å…¨å¼·åŒ–å»ºè­°
          ï¼ˆé‡å° VMTO æž¶æ§‹çš„ç‰¹å®šå»ºè­°ï¼‰

          ### ðŸ“Š é¢¨éšªè©•ä¼°
          - æ•´é«”å®‰å…¨é¢¨éšªï¼šé«˜/ä¸­/ä½Ž
          - å»ºè­°ä¿®æ­£æ™‚é™ï¼šX å¤©å…§"

            RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "$(jq -n \
                --arg prompt "$PROMPT" \
                '{
                  model: "gpt-4o",
                  messages: [{role: "user", content: $prompt}],
                  max_tokens: 2000,
                  temperature: 0.2
                }')")

            echo "$RESPONSE" | jq -r '.choices[0].message.content // "AI åˆ†æžæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨"' > /tmp/security-analysis.md
          else
            cat > /tmp/security-analysis.md << REPORT
          ## ðŸ›¡ï¸ å®‰å…¨æŽƒæçµæžœ

          ### âš ï¸ ç™¼ç¾ ${ALERT_COUNT} å€‹å¾…è™•ç†å®‰å…¨è­¦å ±

          > æœªè¨­å®š OPENAI_API_KEYï¼ŒAI åˆ†æžåŠŸèƒ½æœªå•Ÿç”¨ã€‚
          > è«‹è‡³ Settings â†’ Secrets and variables â†’ Actions æ–°å¢ž \`OPENAI_API_KEY\` ä»¥å•Ÿç”¨æ™ºæ…§åˆ†æžã€‚

          è«‹å‰å¾€ [Security > Code scanning](https://github.com/${{ github.repository }}/security/code-scanning) æŸ¥çœ‹è©³ç´°è³‡è¨Šã€‚
          REPORT
          fi

          echo "analysis_done=true" >> $GITHUB_OUTPUT

      - name: ðŸ“ å»ºç«‹å®‰å…¨å ±å‘Šä¸¦ Commit
        if: steps.ai-security.outputs.analysis_done == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_SHA_SHORT="${{ github.sha }}"
          COMMIT_SHA_SHORT="${COMMIT_SHA_SHORT:0:7}"
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          BRANCH="${{ github.ref_name }}"
          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          ALERT_COUNT="${{ steps.get-alerts.outputs.alert_count }}"

          REPORT_DIR=".github/security-reports"
          mkdir -p "$REPORT_DIR"
          REPORT_FILE="$REPORT_DIR/security-scan-${COMMIT_SHA_SHORT}.md"

          {
            echo "# ðŸ›¡ï¸ CodeQL å®‰å…¨æŽƒæå ±å‘Š"
            echo ""
            echo "| é …ç›® | å…§å®¹ |"
            echo "|------|------|"
            echo "| **Commit** | \`${COMMIT_SHA_SHORT}\` |"
            echo "| **åˆ†æ”¯** | \`${BRANCH}\` |"
            echo "| **ä½œè€…** | ${AUTHOR} |"
            echo "| **åŽŸå§‹è¨Šæ¯** | ${COMMIT_MSG} |"
            echo "| **æŽƒææ™‚é–“** | ${TIMESTAMP} |"
            echo "| **é–‹æ”¾è­¦å ±æ•¸** | ${ALERT_COUNT} å€‹ |"
            echo "| **æŽƒæå·¥å…·** | GitHub CodeQL v3 |"
            echo ""
            echo "ðŸ”— [æŸ¥çœ‹å®Œæ•´ Security Alerts](https://github.com/${{ github.repository }}/security/code-scanning)"
            echo ""
            echo "---"
            echo ""
            cat /tmp/security-analysis.md
            echo ""
            echo "---"
            echo ""
            echo "> ðŸ“Œ æœ¬å ±å‘Šç”± GitHub Actions CodeQL å®‰å…¨æŽƒæ Workflow è‡ªå‹•ç”¢ç”Ÿ"
            echo "> å¦‚æœ‰èª¤åˆ¤ï¼Œè«‹è‡³ GitHub Security Code Scanning ä»‹é¢æ¨™è¨˜ç‚ºã€ŒNot a problemã€"
          } > "$REPORT_FILE"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$REPORT_FILE"

          if ! git diff --staged --quiet; then
            SEVERITY_EMOJI="âœ…"
            if [ "$ALERT_COUNT" -gt "0" ] 2>/dev/null; then
              SEVERITY_EMOJI="âš ï¸"
            fi

            git commit -m "ðŸ›¡ï¸ [å®‰å…¨æŽƒæ] Commit ${COMMIT_SHA_SHORT} CodeQL æŽƒæå ±å‘Š

          ðŸ“Œ åŽŸå§‹ Commit: ${COMMIT_SHA_SHORT}
          ðŸ‘¤ ä½œè€…: ${AUTHOR}
          ðŸŒ¿ åˆ†æ”¯: ${BRANCH}
          â° æŽƒææ™‚é–“: ${TIMESTAMP}
          ${SEVERITY_EMOJI} ç™¼ç¾è­¦å ±: ${ALERT_COUNT} å€‹

          æœ¬å ±å‘Šç”± GitHub Actions CodeQL å®‰å…¨æŽƒæ Workflow è‡ªå‹•ç”¢ç”Ÿã€‚
          æŽƒææ¶µè“‹ C#ï¼ˆsrc/ï¼‰èˆ‡ TypeScript/Vue3ï¼ˆfrontend/src/ï¼‰ã€‚

          è©³ç´°å ±å‘Šè«‹è¦‹: ${REPORT_FILE}
          Security Alerts: https://github.com/${{ github.repository }}/security/code-scanning"

            git push origin HEAD:${BRANCH}
            echo "âœ… å®‰å…¨å ±å‘Šå·² commit è‡³åˆ†æ”¯ ${BRANCH}"
          fi

      - name: ðŸ“Š è¼¸å‡ºå®‰å…¨æŽƒææ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ CodeQL å®‰å…¨æŽƒææ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å…§å®¹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¸ç™¼è€… | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é–‹æ”¾è­¦å ±æ•¸ | ${{ steps.get-alerts.outputs.alert_count }} å€‹ |" >> $GITHUB_STEP_SUMMARY
          echo "| æ™‚é–“ | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [æŸ¥çœ‹ Security Alerts](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/security-analysis.md ]; then
            echo "### å®‰å…¨åˆ†æžçµæžœ" >> $GITHUB_STEP_SUMMARY
            cat /tmp/security-analysis.md >> $GITHUB_STEP_SUMMARY
          fi
