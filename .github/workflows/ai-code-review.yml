name: ðŸ” AI ç¨‹å¼ç¢¼å¯©æŸ¥èˆ‡è‡ªå‹•ä¿®æ­£

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    name: AI ç¨‹å¼ç¢¼å¯©æŸ¥
    runs-on: ubuntu-latest
    steps:
      # â”€â”€ 1. å–å¾—ç¨‹å¼ç¢¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # â”€â”€ 2. å–å¾—æœ¬æ¬¡ Push çš„ diff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š å–å¾—æœ¬æ¬¡ Commit å·®ç•°
        id: get-diff
        run: |
          echo "å–å¾— git diff..."
          DIFF=$(git diff HEAD~1 HEAD -- '*.cs' '*.ts' '*.vue' '*.js' '*.json' '*.yaml' '*.yml' 2>/dev/null || git diff HEAD -- '*.cs' '*.ts' '*.vue' '*.js' '*.json' '*.yaml' '*.yml')
          if [ -z "$DIFF" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "æœ¬æ¬¡ Push ç„¡å¯å¯©æŸ¥çš„ç¨‹å¼ç¢¼è®Šæ›´"
          else
            DIFF_TRUNCATED=$(echo "$DIFF" | head -c 10000)
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "diff_b64=$(echo "$DIFF_TRUNCATED" | base64 -w 0)" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ 3. è¨­å®š .NET ç’°å¢ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âš™ï¸ è¨­å®š .NET ç’°å¢ƒ
        if: steps.get-diff.outputs.skip != 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: âš™ï¸ è¨­å®š Node.js ç’°å¢ƒ
        if: steps.get-diff.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # â”€â”€ 4. å‘¼å« OpenAI é€²è¡Œ Code Review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ¤– AI ç¨‹å¼ç¢¼å¯©æŸ¥åˆ†æž
        if: steps.get-diff.outputs.skip != 'true'
        id: ai-review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DIFF_CONTENT=$(echo "${{ steps.get-diff.outputs.diff_b64 }}" | base64 -d)
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)

          PROMPT="ä½ æ˜¯ä¸€ä½è³‡æ·±ç¨‹å¼ç¢¼å¯©æŸ¥å“¡ï¼Œå°ˆæ³¨æ–¼ Clean Architectureã€DDDã€C#/.NET 8ã€Vue3/TypeScript æœ€ä½³å¯¦è¸ã€‚

          è«‹å¯©æŸ¥ä»¥ä¸‹ git diffï¼Œä¸¦ä»¥**ç¹é«”ä¸­æ–‡**å›žæ‡‰ã€‚

          å¯©æŸ¥é‡é»žï¼š
          1. ç¨‹å¼ç¢¼å“è³ªå•é¡Œï¼ˆå‘½åã€å¯è®€æ€§ã€è¤‡é›œåº¦ï¼‰
          2. Clean Architecture åˆ†å±¤é•è¦ï¼ˆä¾‹å¦‚ï¼šDomain å±¤ä¸å¯å¼•ç”¨æ¡†æž¶ï¼‰
          3. æ½›åœ¨çš„ Bug æˆ–é‚è¼¯éŒ¯èª¤
          4. æ•ˆèƒ½å•é¡Œ
          5. ç¼ºå°‘éŒ¯èª¤è™•ç†æˆ– CancellationToken å‚³éž

          Commit è³‡è¨Šï¼š
          - SHA: ${COMMIT_SHA:0:7}
          - ä½œè€…: $AUTHOR
          - è¨Šæ¯: $COMMIT_MSG

          Git Diffï¼ˆéƒ¨åˆ†ï¼‰ï¼š
          \`\`\`
          $DIFF_CONTENT
          \`\`\`

          è«‹ä¾ä»¥ä¸‹æ ¼å¼å›žæ‡‰ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼š

          ## ðŸ“‹ ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š

          ### âœ… å„ªé»ž
          ï¼ˆåˆ—å‡ºåšå¾—å¥½çš„éƒ¨åˆ†ï¼‰

          ### âš ï¸ ç™¼ç¾å•é¡Œ
          ï¼ˆä¾åš´é‡æ€§æŽ’åºï¼Œæ¯é …åŒ…å«ï¼šå•é¡Œæè¿°ã€å½±éŸ¿ã€å»ºè­°ä¿®æ­£æ–¹å¼ï¼‰

          ### ðŸ”§ ä¿®æ­£å»ºè­°æ‘˜è¦
          ï¼ˆæ¢åˆ—å¼ï¼Œç°¡æ½”ï¼‰

          ### ðŸ“Š å¯©æŸ¥è©•åˆ†
          - æ•´é«”å“è³ªï¼šX/10
          - Clean Architecture åˆè¦ï¼šX/10
          - å¯ç¶­è­·æ€§ï¼šX/10"

          if [ -n "$OPENAI_API_KEY" ]; then
            RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "$(jq -n \
                --arg prompt "$PROMPT" \
                '{
                  model: "gpt-4o",
                  messages: [{role: "user", content: $prompt}],
                  max_tokens: 2000,
                  temperature: 0.3
                }')")
            REVIEW_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "AI å¯©æŸ¥æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹æ‰‹å‹•å¯©æŸ¥ã€‚"')
          else
            REVIEW_CONTENT="## ðŸ“‹ ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š

          > âš ï¸ æœªè¨­å®š OPENAI_API_KEYï¼ŒAI åˆ†æžåŠŸèƒ½æœªå•Ÿç”¨ã€‚
          > è«‹è‡³ Settings â†’ Secrets and variables â†’ Actions æ–°å¢ž \`OPENAI_API_KEY\`ã€‚

          ### ðŸ”§ éœæ…‹åˆ†æžçµæžœ
          è«‹åƒè€ƒä¸‹æ–¹ .NET å»ºç½®è¼¸å‡ºä»¥ç¢ºèªç¨‹å¼ç¢¼å“è³ªã€‚"
          fi

          echo "$REVIEW_CONTENT" > /tmp/review_report.md
          echo "review_done=true" >> $GITHUB_OUTPUT
          echo "âœ… AI ç¨‹å¼ç¢¼å¯©æŸ¥å®Œæˆ"

      # â”€â”€ 5. å°‡å¯©æŸ¥çµæžœå¯«å…¥ Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“ å»ºç«‹å¯©æŸ¥å ±å‘Šä¸¦ Commit
        if: steps.ai-review.outputs.review_done == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_SHA_SHORT="${{ github.sha }}"
          COMMIT_SHA_SHORT="${COMMIT_SHA_SHORT:0:7}"
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          BRANCH="${{ github.ref_name }}"
          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)

          REPORT_DIR=".github/review-reports"
          mkdir -p "$REPORT_DIR"
          REPORT_FILE="$REPORT_DIR/code-review-${COMMIT_SHA_SHORT}.md"

          {
            echo "# ðŸ” AI ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š"
            echo ""
            echo "| é …ç›® | å…§å®¹ |"
            echo "|------|------|"
            echo "| **Commit** | \`${COMMIT_SHA_SHORT}\` |"
            echo "| **åˆ†æ”¯** | \`${BRANCH}\` |"
            echo "| **ä½œè€…** | ${AUTHOR} |"
            echo "| **åŽŸå§‹è¨Šæ¯** | ${COMMIT_MSG} |"
            echo "| **å¯©æŸ¥æ™‚é–“** | ${TIMESTAMP} |"
            echo "| **å¯©æŸ¥å·¥å…·** | GitHub Actions + GPT-4o |"
            echo ""
            echo "---"
            echo ""
            cat /tmp/review_report.md
          } > "$REPORT_FILE"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$REPORT_FILE"

          if ! git diff --staged --quiet; then
            git commit -m "ðŸ” [AIå¯©æŸ¥] Commit ${COMMIT_SHA_SHORT} ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š

          ðŸ“Œ åŽŸå§‹ Commit: ${COMMIT_SHA_SHORT}
          ðŸ‘¤ ä½œè€…: ${AUTHOR}
          ðŸŒ¿ åˆ†æ”¯: ${BRANCH}
          â° æ™‚é–“: ${TIMESTAMP}

          æœ¬å ±å‘Šç”± GitHub Actions AI ç¨‹å¼ç¢¼å¯©æŸ¥ Workflow è‡ªå‹•ç”¢ç”Ÿï¼Œ
          ä½¿ç”¨ GPT-4o å°æœ¬æ¬¡ push çš„ç¨‹å¼ç¢¼è®Šæ›´é€²è¡Œåˆ†æžã€‚

          è©³ç´°å ±å‘Šè«‹è¦‹: ${REPORT_FILE}"

            git push origin HEAD:${BRANCH}
            echo "âœ… å¯©æŸ¥å ±å‘Šå·² commit è‡³åˆ†æ”¯ ${BRANCH}"
          else
            echo "âš ï¸ ç„¡æ–°å ±å‘Šéœ€è¦ commit"
          fi

      # â”€â”€ 6. .NET å»ºç½®é©—è­‰ï¼ˆéœæ…‹åˆ†æžï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”§ .NET å»ºç½®é©—è­‰ï¼ˆéœæ…‹åˆ†æžï¼‰
        if: steps.get-diff.outputs.skip != 'true'
        run: |
          echo "â–¶ï¸ åŸ·è¡Œ .NET å»ºç½®èˆ‡éœæ…‹åˆ†æž..."
          dotnet build VMTO.sln --no-incremental -warnaserror 2>&1 | tee /tmp/build-output.txt || true
          echo "âœ… å»ºç½®åˆ†æžå®Œæˆ"
        continue-on-error: true

      # â”€â”€ 7. è¼¸å‡ºæ‘˜è¦è‡³ GitHub Step Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š è¼¸å‡ºå¯©æŸ¥æ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ” AI ç¨‹å¼ç¢¼å¯©æŸ¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¸ç™¼è€… | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯©æŸ¥æ™‚é–“ | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/review_report.md ]; then
            echo "### å¯©æŸ¥çµæžœ" >> $GITHUB_STEP_SUMMARY
            cat /tmp/review_report.md >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f /tmp/build-output.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ å»ºç½®è¼¸å‡ºï¼ˆæ‘˜è¦ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 /tmp/build-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
